name: Cleanup Orphaned Signatures

on:
  schedule:
    - cron: '0 0 * * 0' # Run every Sunday at midnight
  workflow_dispatch: # Allow manual trigger
    inputs:
      dry_run:
        description: 'Dry Run (true/false)'
        required: false
        default: 'false'

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  ECR_IMAGE_REPO: ${{ vars.ECR_IMAGE_REPO }}
  ECR_SIG_REPO: ${{ vars.ECR_SIG_REPO }}

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          # Use the Admin/Terraform role since it has permission to list/delete in all repos
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Boto3
        run: pip install boto3

      - name: Run Cleanup Script
        env:
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        run: python scripts/cleanup_orphans.py
